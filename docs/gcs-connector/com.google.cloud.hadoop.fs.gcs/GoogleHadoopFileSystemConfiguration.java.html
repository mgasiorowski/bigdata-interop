<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../../jacoco-resources/report.gif" type="image/gif"/><title>GoogleHadoopFileSystemConfiguration.java</title><link rel="stylesheet" href="../../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../../index.html" class="el_report">coverage</a> &gt; <a href="../index.html" class="el_bundle">gcs-connector</a> &gt; <a href="index.source.html" class="el_package">com.google.cloud.hadoop.fs.gcs</a> &gt; <span class="el_source">GoogleHadoopFileSystemConfiguration.java</span></div><h1>GoogleHadoopFileSystemConfiguration.java</h1><pre class="source lang-java linenums">/*
 * Copyright 2013 Google Inc. All Rights Reserved.
 *
 * Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *    http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an &quot;AS IS&quot; BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

package com.google.cloud.hadoop.fs.gcs;

import static com.google.cloud.hadoop.fs.gcs.GoogleHadoopFileSystemBase.PATH_CODEC_USE_URI_ENCODING;
import static com.google.common.base.Strings.nullToEmpty;

import com.google.cloud.hadoop.fs.gcs.GoogleHadoopFileSystemBase.GcsFileChecksumType;
import com.google.cloud.hadoop.fs.gcs.GoogleHadoopFileSystemBase.OutputStreamType;
import com.google.cloud.hadoop.fs.gcs.GoogleHadoopFileSystemBase.ParentTimestampUpdateIncludePredicate;
import com.google.cloud.hadoop.gcsio.GoogleCloudStorageFileSystemOptions;
import com.google.cloud.hadoop.gcsio.GoogleCloudStorageOptions;
import com.google.cloud.hadoop.gcsio.GoogleCloudStorageReadOptions;
import com.google.cloud.hadoop.gcsio.GoogleCloudStorageReadOptions.Fadvise;
import com.google.cloud.hadoop.gcsio.GoogleCloudStorageReadOptions.GenerationReadConsistency;
import com.google.cloud.hadoop.gcsio.PerformanceCachingGoogleCloudStorageOptions;
import com.google.cloud.hadoop.gcsio.cooplock.CooperativeLockingOptions;
import com.google.cloud.hadoop.util.AsyncWriteChannelOptions;
import com.google.cloud.hadoop.util.EntriesCredentialConfiguration;
import com.google.cloud.hadoop.util.HadoopCredentialConfiguration;
import com.google.cloud.hadoop.util.HttpTransportFactory.HttpTransportType;
import com.google.cloud.hadoop.util.RequesterPaysOptions;
import com.google.cloud.hadoop.util.RequesterPaysOptions.RequesterPaysMode;
import com.google.common.annotations.VisibleForTesting;
import com.google.common.collect.ImmutableList;
import com.google.common.flogger.GoogleLogger;
import java.util.Collection;
import org.apache.hadoop.conf.Configuration;
import org.apache.hadoop.fs.permission.FsPermission;

/** This class provides a configuration for the {@link GoogleHadoopFileSystem} implementations. */
<span class="nc" id="L46">public class GoogleHadoopFileSystemConfiguration {</span>
<span class="fc" id="L47">  private static final GoogleLogger logger = GoogleLogger.forEnclosingClass();</span>

  /** Configuration key for the MR intermediate done dir. */
  public static final String MR_JOB_HISTORY_INTERMEDIATE_DONE_DIR_KEY =
      &quot;mapreduce.jobhistory.intermediate-done-dir&quot;;

  /** Configuration key of the MR done directory. */
  public static final String MR_JOB_HISTORY_DONE_DIR_KEY = &quot;mapreduce.jobhistory.done-dir&quot;;

  // -----------------------------------------------------------------
  // Configuration settings.
  // -----------------------------------------------------------------

  /**
   * Key for the permissions that we report a file or directory to have. Can either be octal or
   * symbolic mode accepted by {@link FsPermission#FsPermission(String)}
   *
   * &lt;p&gt;Default value for the permissions that we report a file or directory to have. Note: We do
   * not really support file/dir permissions but we need to report some permission value when Hadoop
   * calls getFileStatus(). A MapReduce job fails if we report permissions more relaxed than the
   * value below and this is the default File System.
   */
<span class="fc" id="L69">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt; PERMISSIONS_TO_REPORT =</span>
      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.reported.permissions&quot;, &quot;700&quot;);

  /**
   * Configuration key for default block size of a file.
   *
   * &lt;p&gt;Note that this is the size that is reported to Hadoop FS clients. It does not modify the
   * actual block size of an underlying GCS object, because GCS JSON API does not allow modifying or
   * querying the value. Modifying this value allows one to control how many mappers are used to
   * process a given file.
   */
<span class="fc" id="L80">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Long&gt; BLOCK_SIZE =</span>
<span class="fc" id="L81">      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.block.size&quot;, 64 * 1024 * 1024L);</span>

  /**
   * Configuration key for enabling GCE service account authentication. This key is deprecated. See
   * {@link HadoopCredentialConfiguration} for current key names.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt;
<span class="fc" id="L88">      AUTH_SERVICE_ACCOUNT_ENABLE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.enable.service.account.auth&quot;);

  /**
   * Configuration key specifying the email address of the service-account with which to
   * authenticate. Only required if {@link #AUTH_SERVICE_ACCOUNT_ENABLE} is true AND we're using
   * fs.gs.service.account.auth.keyfile to authenticate with a private keyfile. NB: Once GCE
   * supports setting multiple service account email addresses for metadata auth, this key will also
   * be used in the metadata auth flow. This key is deprecated. See {@link
   * HadoopCredentialConfiguration} for current key names.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt;
<span class="fc" id="L100">      AUTH_SERVICE_ACCOUNT_EMAIL =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.service.account.auth.email&quot;);

  /**
   * Configuration key specifying local file containing a service-account private .p12 keyfile. Only
   * used if {@link #AUTH_SERVICE_ACCOUNT_ENABLE} is true; if provided, the keyfile will be used for
   * service-account authentication. Otherwise, it is assumed that we are on a GCE VM with
   * metadata-authentication for service-accounts enabled, and the metadata server will be used
   * instead. Default value: none This key is deprecated. See {@link HadoopCredentialConfiguration}
   * for current key names.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt;
<span class="fc" id="L112">      AUTH_SERVICE_ACCOUNT_KEY_FILE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.service.account.auth.keyfile&quot;);

  /**
   * Configuration key for GCS client ID. Required if {@link #AUTH_SERVICE_ACCOUNT_ENABLE} == false.
   * Default value: none This key is deprecated. See {@link HadoopCredentialConfiguration} for
   * current key names.
   */
<span class="fc" id="L120">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt; AUTH_CLIENT_ID =</span>
      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.client.id&quot;);
  /**
   * Configuration key for GCS client secret. Required if {@link #AUTH_SERVICE_ACCOUNT_ENABLE} ==
   * false. Default value: none This key is deprecated. See HadoopCredentialConfiguration for
   * current key names.
   */
<span class="fc" id="L127">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt; AUTH_CLIENT_SECRET =</span>
      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.client.secret&quot;);

  /** Configuration key for Delegation Token binding class. Default value: none */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt;
<span class="fc" id="L132">      DELEGATION_TOKEN_BINDING_CLASS =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.delegation.token.binding&quot;);

  /** Configuration key for GCS project ID. Default value: none */
<span class="fc" id="L136">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt; GCS_PROJECT_ID =</span>
      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.project.id&quot;);

  /** Configuration key for initial working directory of a GHFS instance. Default value: '/' */
<span class="fc" id="L140">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt; GCS_WORKING_DIRECTORY =</span>
      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.working.dir&quot;, &quot;/&quot;);

  /**
   * If true, recursive delete on a path that refers to a GCS bucket itself ('/' for any
   * bucket-rooted GoogleHadoopFileSystem) or delete on that path when it's empty will result in
   * fully deleting the GCS bucket. If false, any operation that normally would have deleted the
   * bucket will be ignored instead. Setting to 'false' preserves the typical behavior of &quot;rm -rf /&quot;
   * which translates to deleting everything inside of root, but without clobbering the filesystem
   * authority corresponding to that root path in the process.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L152">      GCE_BUCKET_DELETE_ENABLE =</span>
<span class="fc" id="L153">          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.bucket.delete.enable&quot;, false);</span>

  /** Configuration key for GCS project ID. Default value: &quot;DISABLED&quot; */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;RequesterPaysMode&gt;
<span class="fc" id="L157">      GCS_REQUESTER_PAYS_MODE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              &quot;fs.gs.requester.pays.mode&quot;, RequesterPaysOptions.REQUESTER_PAYS_MODE_DEFAULT);

  /** Configuration key for GCS Requester Pays Project ID. Default value: none */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt;
<span class="fc" id="L163">      GCS_REQUESTER_PAYS_PROJECT_ID =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.requester.pays.project.id&quot;);

  /** Configuration key for GCS Requester Pays Buckets. Default value: none */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Collection&lt;String&gt;&gt;
<span class="fc" id="L168">      GCS_REQUESTER_PAYS_BUCKETS =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L170">              &quot;fs.gs.requester.pays.buckets&quot;, ImmutableList.of());</span>

  /**
   * Configuration key for which type of FileChecksum to return; if a particular file doesn't
   * support the requested type, then getFileChecksum() will return null for that file.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;GcsFileChecksumType&gt;
<span class="fc" id="L177">      GCS_FILE_CHECKSUM_TYPE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              &quot;fs.gs.checksum.type&quot;, GcsFileChecksumType.NONE);

  /**
   * Configuration key for using a local item cache to supplement GCS API &quot;getFile&quot; results. This
   * provides faster access to recently queried data. Because the data is cached, modifications made
   * outside of this instance may not be immediately reflected. The performance cache can be used in
   * conjunction with other caching options.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L188">      GCS_PERFORMANCE_CACHE_ENABLE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L190">              &quot;fs.gs.performance.cache.enable&quot;, false);</span>

  /**
   * Configuration key for maximum number of milliseconds a GoogleCloudStorageItemInfo will remain
   * &quot;valid&quot; in the performance cache before it's invalidated.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Long&gt;
<span class="fc" id="L197">      GCS_PERFORMANCE_CACHE_MAX_ENTRY_AGE_MILLIS =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              &quot;fs.gs.performance.cache.max.entry.age.ms&quot;,
<span class="fc" id="L200">              PerformanceCachingGoogleCloudStorageOptions.MAX_ENTRY_AGE_MILLIS_DEFAULT);</span>

  /** Configuration key for whether or not to enable list caching for the performance cache. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L204">      GCS_PERFORMANCE_CACHE_LIST_CACHING_ENABLE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              &quot;fs.gs.performance.cache.list.caching.enable&quot;,
<span class="fc" id="L207">              PerformanceCachingGoogleCloudStorageOptions.LIST_CACHING_ENABLED);</span>

  /**
   * If true, executes GCS requests in {@code listStatus} and {@code getFileStatus} methods in
   * parallel to reduce latency.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L214">      GCS_STATUS_PARALLEL_ENABLE =</span>
<span class="fc" id="L215">          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.status.parallel.enable&quot;, false);</span>

  /**
   * Configuration key for whether or not we should update timestamps for parent directories when we
   * create new files in them.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L222">      GCS_PARENT_TIMESTAMP_UPDATE_ENABLE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L224">              &quot;fs.gs.parent.timestamp.update.enable&quot;, true);</span>

  /**
   * Configuration key containing a comma-separated list of sub-strings that when matched will cause
   * a particular directory to not have its modification timestamp updated. Includes take precedence
   * over excludes.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Collection&lt;String&gt;&gt;
<span class="fc" id="L232">      GCS_PARENT_TIMESTAMP_UPDATE_EXCLUDES =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L234">              &quot;fs.gs.parent.timestamp.update.substrings.excludes&quot;, ImmutableList.of(&quot;/&quot;));</span>

  /**
   * Configuration key containing a comma-separated list of sub-strings that when matched will cause
   * a particular directory to have its modification timestamp updated. Includes take precedence
   * over excludes.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Collection&lt;String&gt;&gt;
<span class="fc" id="L242">      GCS_PARENT_TIMESTAMP_UPDATE_INCLUDES =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              &quot;fs.gs.parent.timestamp.update.substrings.includes&quot;,
<span class="fc" id="L245">              ImmutableList.of(</span>
                  &quot;${&quot; + MR_JOB_HISTORY_INTERMEDIATE_DONE_DIR_KEY + &quot;}&quot;,
                  &quot;${&quot; + MR_JOB_HISTORY_DONE_DIR_KEY + &quot;}&quot;));

  /** Configuration key for enabling lazy initialization of GCS FS instance. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L251">      GCS_LAZY_INITIALIZATION_ENABLE =</span>
<span class="fc" id="L252">          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.lazy.init.enable&quot;, false);</span>

  /**
   * Configuration key for enabling automatic repair of implicit directories whenever detected
   * inside delete and rename calls.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L259">      GCS_REPAIR_IMPLICIT_DIRECTORIES_ENABLE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L261">              &quot;fs.gs.implicit.dir.repair.enable&quot;, true);</span>

  /** Configuration key for changing the path codec from legacy to 'uri path encoding'. */
<span class="fc" id="L264">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt; PATH_CODEC =</span>
      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
          &quot;fs.gs.path.encoding&quot;, PATH_CODEC_USE_URI_ENCODING);

  /**
   * Configuration key for enabling automatic inference of implicit directories. If set, we create
   * and return in-memory directory objects on the fly when no backing object exists, but we know
   * there are files with the same prefix.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L274">      GCS_INFER_IMPLICIT_DIRECTORIES_ENABLE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L276">              &quot;fs.gs.implicit.dir.infer.enable&quot;, true);</span>

  /**
   * Configuration key for enabling the use of a large flat listing to pre-populate possible glob
   * matches in a single API call before running the core globbing logic in-memory rather than
   * sequentially and recursively performing API calls.
   */
<span class="fc" id="L283">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt; GCS_FLAT_GLOB_ENABLE =</span>
<span class="fc" id="L284">      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.glob.flatlist.enable&quot;, true);</span>

  /**
   * Configuration key for enabling the use of flat and regular glob search algorithms in two
   * parallel threads. After the first one returns result, the other one will be interrupted.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L291">      GCS_CONCURRENT_GLOB_ENABLE =</span>
<span class="fc" id="L292">          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.glob.concurrent.enable&quot;, true);</span>

  /** Configuration key for marker file pattern. Default value: none */
<span class="fc" id="L295">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt; GCS_MARKER_FILE_PATTERN =</span>
      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.marker.file.pattern&quot;);

  /** Configuration key for a max number of GCS RPCs in batch request. */
<span class="fc" id="L299">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Long&gt; GCS_MAX_REQUESTS_PER_BATCH =</span>
<span class="fc" id="L300">      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.max.requests.per.batch&quot;, 15L);</span>

  /** Configuration key for a number of threads to execute batch requests. */
<span class="fc" id="L303">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Integer&gt; GCS_BATCH_THREADS =</span>
<span class="fc" id="L304">      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.batch.threads&quot;, 15);</span>

  /** Configuration key for a max number of GCS RPCs in batch request for copy operations. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Long&gt;
<span class="fc" id="L308">      GCS_COPY_MAX_REQUESTS_PER_BATCH =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L310">              &quot;fs.gs.copy.max.requests.per.batch&quot;, 15L);</span>

  /** Configuration key for a number of threads to execute batch requests for copy operations. */
<span class="fc" id="L313">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Integer&gt; GCS_COPY_BATCH_THREADS =</span>
<span class="fc" id="L314">      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.copy.batch.threads&quot;, 15);</span>

  /**
   * Configuration key for enabling the use of Rewrite requests for copy operations. Rewrite request
   * has the same effect as Copy request, but it can handle moving large objects that may
   * potentially timeout a Copy request.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L322">      GCS_COPY_WITH_REWRITE_ENABLE =</span>
<span class="fc" id="L323">          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.copy.with.rewrite.enable&quot;, true);</span>

  /**
   * Configuration key for specifying max number of bytes rewritten in a single rewrite request when
   * fs.gs.copy.with.rewrite.enable is set to 'true'.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Long&gt;
<span class="fc" id="L330">      GCS_REWRITE_MAX_BYTES_PER_CALL =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L332">              &quot;fs.gs.rewrite.max.bytes.per.call&quot;, 512 * 1024 * 1024L);</span>

  /** Configuration key for number of items to return per call to the list* GCS RPCs. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Long&gt;
<span class="fc" id="L336">      GCS_MAX_LIST_ITEMS_PER_CALL =</span>
<span class="fc" id="L337">          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.list.max.items.per.call&quot;, 1024L);</span>

  /**
   * Configuration key for the max number of retries for failed HTTP request to GCS. Note that the
   * connector will retry *up to* the number of times as specified, using a default
   * ExponentialBackOff strategy.
   *
   * &lt;p&gt;Also, note that this number will only control the number of retries in the low level HTTP
   * request implementation.
   */
<span class="fc" id="L347">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Integer&gt; GCS_HTTP_MAX_RETRY =</span>
<span class="fc" id="L348">      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.http.max.retry&quot;, 10);</span>

  /** Configuration key for the connect timeout (in millisecond) for HTTP request to GCS. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Integer&gt;
<span class="fc" id="L352">      GCS_HTTP_CONNECT_TIMEOUT =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L354">              &quot;fs.gs.http.connect-timeout&quot;, 20 * 1000);</span>

  /** Configuration key for the connect timeout (in millisecond) for HTTP request to GCS. */
<span class="fc" id="L357">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Integer&gt; GCS_HTTP_READ_TIMEOUT =</span>
<span class="fc" id="L358">      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.http.read-timeout&quot;, 20 * 1000);</span>

  /**
   * Configuration key for setting a proxy for the connector to use to connect to GCS. The proxy
   * must be an HTTP proxy of the form &quot;host:port&quot;.
   */
<span class="fc" id="L364">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt; GCS_PROXY_ADDRESS =</span>
      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
          EntriesCredentialConfiguration.PROXY_ADDRESS_KEY,
          EntriesCredentialConfiguration.PROXY_ADDRESS_DEFAULT);

  /**
   * Configuration key for setting a proxy username for the connector to use to authenticate with
   * proxy used to connect to GCS.
   */
<span class="fc" id="L373">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt; GCS_PROXY_USERNAME =</span>
      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
          EntriesCredentialConfiguration.PROXY_USERNAME_KEY,
          EntriesCredentialConfiguration.PROXY_USERNAME_DEFAULT);

  /**
   * Configuration key for setting a proxy password for the connector to use to authenticate with
   * proxy used to connect to GCS.
   */
<span class="fc" id="L382">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt; GCS_PROXY_PASSWORD =</span>
      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
          EntriesCredentialConfiguration.PROXY_PASSWORD_KEY,
          EntriesCredentialConfiguration.PROXY_PASSWORD_DEFAULT);

  /**
   * Configuration key for the name of HttpTransport class to use for connecting to GCS. Must be the
   * name of an HttpTransportFactory.HttpTransportType (APACHE or JAVA_NET).
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;HttpTransportType&gt;
<span class="fc" id="L392">      GCS_HTTP_TRANSPORT =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              EntriesCredentialConfiguration.HTTP_TRANSPORT_KEY,
              EntriesCredentialConfiguration.HTTP_TRANSPORT_DEFAULT);

  /** Configuration key for adding a suffix to the GHFS application name sent to GCS. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt;
<span class="fc" id="L399">      GCS_APPLICATION_NAME_SUFFIX =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.application.name.suffix&quot;, &quot;&quot;);

  /**
   * Configuration key for modifying the maximum amount of time to wait for empty object creation.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Integer&gt;
<span class="fc" id="L406">      GCS_MAX_WAIT_MILLIS_EMPTY_OBJECT_CREATE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L408">              &quot;fs.gs.max.wait.for.empty.object.creation.ms&quot;, 3_000);</span>

  /**
   * Configuration key for which type of output stream to use; different options may have different
   * degrees of support for advanced features like {@code hsync()} and different performance
   * characteristics. Options:
   *
   * &lt;p&gt;BASIC: Stream is closest analogue to direct wrapper around low-level HTTP stream into GCS.
   *
   * &lt;p&gt;SYNCABLE_COMPOSITE: Stream behaves similarly to BASIC when used with basic
   * create/write/close patterns, but supports hsync() by creating discrete temporary GCS objects
   * which are composed onto the destination object.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;OutputStreamType&gt;
<span class="fc" id="L422">      GCS_OUTPUT_STREAM_TYPE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              &quot;fs.gs.outputstream.type&quot;, OutputStreamType.BASIC);

  /** Configuration key for setting write buffer size. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Integer&gt;
<span class="fc" id="L428">      GCS_OUTPUT_STREAM_BUFFER_SIZE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L430">              &quot;fs.gs.outputstream.buffer.size&quot;, 8 * 1024 * 1024);</span>

  /** Configuration key for setting pipe buffer size. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Integer&gt;
<span class="fc" id="L434">      GCS_OUTPUT_STREAM_PIPE_BUFFER_SIZE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L436">              &quot;fs.gs.outputstream.pipe.buffer.size&quot;, 1024 * 1024);</span>

  /** Configuration key for setting GCS upload chunk size. */
  // chunk size etc. Get the following value from GCSWC class in a better way. For now, we hard code
  // it to a known good value.
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Integer&gt;
<span class="fc" id="L442">      GCS_OUTPUT_STREAM_UPLOAD_CHUNK_SIZE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              &quot;fs.gs.outputstream.upload.chunk.size&quot;,
<span class="fc" id="L445">              64 * 1024 * 1024,</span>
              &quot;fs.gs.io.buffersize.write&quot;);

  /** Configuration key for enabling GCS direct upload. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L450">      GCS_OUTPUT_STREAM_DIRECT_UPLOAD_ENABLE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L452">              &quot;fs.gs.outputstream.direct.upload.enable&quot;, false);</span>

  /** Configuration key for the generation consistency read model. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;GenerationReadConsistency&gt;
<span class="fc" id="L456">      GCS_GENERATION_READ_CONSISTENCY =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              &quot;fs.gs.generation.read.consistency&quot;,
              GoogleCloudStorageReadOptions.DEFAULT_GENERATION_READ_CONSISTENCY);

  /** Configuration key for setting read buffer size. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Integer&gt;
<span class="fc" id="L463">      GCS_INPUT_STREAM_BUFFER_SIZE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L465">              &quot;fs.gs.inputstream.buffer.size&quot;, 0, &quot;fs.gs.io.buffersize&quot;);</span>

  /**
   * If true, on opening a file we will proactively perform a metadata GET to check whether the
   * object exists, even though the underlying channel will not open a data stream until read() is
   * actually called so that streams can seek to nonzero file positions without incurring an extra
   * stream creation. This is necessary to technically match the expected behavior of Hadoop
   * filesystems, but incurs extra latency overhead on open(). If the calling code can handle late
   * failures on not-found errors, or has independently already ensured that a file exists before
   * calling open(), then set this to false for more efficient reads.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L477">      GCS_INPUT_STREAM_FAST_FAIL_ON_NOT_FOUND_ENABLE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L479">              &quot;fs.gs.inputstream.fast.fail.on.not.found.enable&quot;, true);</span>

  /**
   * If true, reading a file with GZIP content encoding (HTTP header &quot;Content-Encoding: gzip&quot;) will
   * result in failure (IOException is thrown).
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L486">      GCS_INPUT_STREAM_SUPPORT_GZIP_ENCODING_ENABLE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L488">              &quot;fs.gs.inputstream.support.gzip.encoding.enable&quot;, false);</span>

  /**
   * If forward seeks are within this many bytes of the current position, seeks are performed by
   * reading and discarding bytes in-place rather than opening a new underlying stream.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Long&gt;
<span class="fc" id="L495">      GCS_INPUT_STREAM_INPLACE_SEEK_LIMIT =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L497">              &quot;fs.gs.inputstream.inplace.seek.limit&quot;, 8 * 1024 * 1024L);</span>

  /** Tunes reading objects behavior to optimize HTTP GET requests for various use cases. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Fadvise&gt;
<span class="fc" id="L501">      GCS_INPUT_STREAM_FADVISE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              &quot;fs.gs.inputstream.fadvise&quot;, Fadvise.AUTO);

  /**
   * Minimum size in bytes of the HTTP Range header set in GCS request when opening new stream to
   * read an object.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Integer&gt;
<span class="fc" id="L510">      GCS_INPUT_STREAM_MIN_RANGE_REQUEST_SIZE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              &quot;fs.gs.inputstream.min.range.request.size&quot;,
<span class="fc" id="L513">              GoogleCloudStorageReadOptions.DEFAULT_MIN_RANGE_REQUEST_SIZE);</span>

  /** Override configuration file path. This file must be a valid Hadoop configuration file. */
<span class="fc" id="L516">  public static final GoogleHadoopFileSystemConfigurationProperty&lt;String&gt; GCS_CONFIG_OVERRIDE_FILE =</span>
      new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(&quot;fs.gs.config.override.file&quot;, null);

  /**
   * Configuration key for using cooperative locking to achieve a directory mutation operations
   * isolation.
   */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Boolean&gt;
<span class="fc" id="L524">      GCS_COOPERATIVE_LOCKING_ENABLE =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
<span class="fc" id="L526">              &quot;fs.gs.cooperative.locking.enable&quot;, false);</span>

  /** Configuration key for lock expiration when using cooperative locking. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Long&gt;
<span class="fc" id="L530">      GCS_COOPERATIVE_LOCKING_EXPIRATION_TIMEOUT_MS =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              &quot;fs.gs.cooperative.locking.expiration.timeout.ms&quot;,
<span class="fc" id="L533">              CooperativeLockingOptions.LOCK_EXPIRATION_TIMEOUT_MS_DEFAULT);</span>

  /** Configuration key for maximum allowed concurrent operations when using cooperative locking. */
  public static final GoogleHadoopFileSystemConfigurationProperty&lt;Integer&gt;
<span class="fc" id="L537">      GCS_COOPERATIVE_LOCKING_MAX_CONCURRENT_OPERATIONS =</span>
          new GoogleHadoopFileSystemConfigurationProperty&lt;&gt;(
              &quot;fs.gs.cooperative.locking.max.concurrent.operations&quot;,
<span class="fc" id="L540">              CooperativeLockingOptions.MAX_CONCURRENT_OPERATIONS_DEFAULT);</span>

  // TODO(b/120887495): This @VisibleForTesting annotation was being ignored by prod code.
  // Please check that removing it is correct, and remove this comment along with it.
  // @VisibleForTesting
  static GoogleCloudStorageFileSystemOptions.Builder getGcsFsOptionsBuilder(Configuration config) {
<span class="fc" id="L546">    return GoogleCloudStorageFileSystemOptions.builder()</span>
<span class="fc" id="L547">        .setBucketDeleteEnabled(GCE_BUCKET_DELETE_ENABLE.get(config, config::getBoolean))</span>
<span class="fc" id="L548">        .setShouldIncludeInTimestampUpdatesPredicate(</span>
<span class="fc" id="L549">            ParentTimestampUpdateIncludePredicate.create(config))</span>
<span class="fc" id="L550">        .setMarkerFilePattern(GCS_MARKER_FILE_PATTERN.get(config, config::get))</span>
<span class="fc" id="L551">        .setPerformanceCacheEnabled(GCS_PERFORMANCE_CACHE_ENABLE.get(config, config::getBoolean))</span>
<span class="fc" id="L552">        .setCooperativeLockingEnabled(</span>
<span class="fc" id="L553">            GCS_COOPERATIVE_LOCKING_ENABLE.get(config, config::getBoolean))</span>
<span class="fc" id="L554">        .setPerformanceCacheOptions(getPerformanceCachingOptions(config))</span>
<span class="fc" id="L555">        .setStatusParallelEnabled(GCS_STATUS_PARALLEL_ENABLE.get(config, config::getBoolean))</span>
<span class="fc" id="L556">        .setCloudStorageOptions(getGcsOptionsBuilder(config).build());</span>
  }

  @VisibleForTesting
  static GoogleCloudStorageOptions.Builder getGcsOptionsBuilder(Configuration config) {
<span class="fc" id="L561">    String projectId = GCS_PROJECT_ID.get(config, config::get);</span>
<span class="fc" id="L562">    return GoogleCloudStorageOptions.builder()</span>
<span class="fc" id="L563">        .setAutoRepairImplicitDirectoriesEnabled(</span>
<span class="fc" id="L564">            GCS_REPAIR_IMPLICIT_DIRECTORIES_ENABLE.get(config, config::getBoolean))</span>
<span class="fc" id="L565">        .setInferImplicitDirectoriesEnabled(</span>
<span class="fc" id="L566">            GCS_INFER_IMPLICIT_DIRECTORIES_ENABLE.get(config, config::getBoolean))</span>
<span class="fc" id="L567">        .setCopyWithRewriteEnabled(GCS_COPY_WITH_REWRITE_ENABLE.get(config, config::getBoolean))</span>
<span class="fc" id="L568">        .setMaxBytesRewrittenPerCall(GCS_REWRITE_MAX_BYTES_PER_CALL.get(config, config::getLong))</span>
<span class="fc" id="L569">        .setCopyMaxRequestsPerBatch(GCS_COPY_MAX_REQUESTS_PER_BATCH.get(config, config::getLong))</span>
<span class="fc" id="L570">        .setCopyBatchThreads(GCS_COPY_BATCH_THREADS.get(config, config::getInt))</span>
<span class="fc" id="L571">        .setTransportType(GCS_HTTP_TRANSPORT.get(config, config::getEnum))</span>
<span class="fc" id="L572">        .setProxyAddress(GCS_PROXY_ADDRESS.get(config, config::get))</span>
<span class="fc" id="L573">        .setProxyUsername(GCS_PROXY_USERNAME.getPassword(config))</span>
<span class="fc" id="L574">        .setProxyPassword(GCS_PROXY_PASSWORD.getPassword(config))</span>
<span class="fc" id="L575">        .setProjectId(projectId)</span>
<span class="fc" id="L576">        .setMaxListItemsPerCall(GCS_MAX_LIST_ITEMS_PER_CALL.get(config, config::getLong))</span>
<span class="fc" id="L577">        .setMaxRequestsPerBatch(GCS_MAX_REQUESTS_PER_BATCH.get(config, config::getLong))</span>
<span class="fc" id="L578">        .setBatchThreads(GCS_BATCH_THREADS.get(config, config::getInt))</span>
<span class="fc" id="L579">        .setMaxHttpRequestRetries(GCS_HTTP_MAX_RETRY.get(config, config::getInt))</span>
<span class="fc" id="L580">        .setHttpRequestConnectTimeout(GCS_HTTP_CONNECT_TIMEOUT.get(config, config::getInt))</span>
<span class="fc" id="L581">        .setHttpRequestReadTimeout(GCS_HTTP_READ_TIMEOUT.get(config, config::getInt))</span>
<span class="fc" id="L582">        .setAppName(getApplicationName(config))</span>
<span class="fc" id="L583">        .setMaxWaitMillisForEmptyObjectCreation(</span>
<span class="fc" id="L584">            GCS_MAX_WAIT_MILLIS_EMPTY_OBJECT_CREATE.get(config, config::getInt))</span>
<span class="fc" id="L585">        .setReadChannelOptions(getReadChannelOptions(config))</span>
<span class="fc" id="L586">        .setWriteChannelOptions(getWriteChannelOptions(config))</span>
<span class="fc" id="L587">        .setRequesterPaysOptions(getRequesterPaysOptions(config, projectId))</span>
<span class="fc" id="L588">        .setCooperativeLockingOptions(getCooperativeLockingOptions(config));</span>
  }

  private static PerformanceCachingGoogleCloudStorageOptions getPerformanceCachingOptions(
      Configuration config) {
<span class="fc" id="L593">    return PerformanceCachingGoogleCloudStorageOptions.builder()</span>
<span class="fc" id="L594">        .setMaxEntryAgeMillis(</span>
<span class="fc" id="L595">            GCS_PERFORMANCE_CACHE_MAX_ENTRY_AGE_MILLIS.get(config, config::getLong))</span>
<span class="fc" id="L596">        .setListCachingEnabled(</span>
<span class="fc" id="L597">            GCS_PERFORMANCE_CACHE_LIST_CACHING_ENABLE.get(config, config::getBoolean))</span>
<span class="fc" id="L598">        .build();</span>
  }

  private static String getApplicationName(Configuration config) {
<span class="fc" id="L602">    String appNameSuffix = nullToEmpty(GCS_APPLICATION_NAME_SUFFIX.get(config, config::get));</span>
<span class="fc" id="L603">    String applicationName = GoogleHadoopFileSystem.GHFS_ID + appNameSuffix;</span>
<span class="fc" id="L604">    logger.atFine().log(&quot;Setting GCS application name to %s&quot;, applicationName);</span>
<span class="fc" id="L605">    return applicationName;</span>
  }

  private static GoogleCloudStorageReadOptions getReadChannelOptions(Configuration config) {
<span class="fc" id="L609">    return GoogleCloudStorageReadOptions.builder()</span>
<span class="fc" id="L610">        .setFastFailOnNotFound(</span>
<span class="fc" id="L611">            GCS_INPUT_STREAM_FAST_FAIL_ON_NOT_FOUND_ENABLE.get(config, config::getBoolean))</span>
<span class="fc" id="L612">        .setSupportGzipEncoding(</span>
<span class="fc" id="L613">            GCS_INPUT_STREAM_SUPPORT_GZIP_ENCODING_ENABLE.get(config, config::getBoolean))</span>
<span class="fc" id="L614">        .setInplaceSeekLimit(GCS_INPUT_STREAM_INPLACE_SEEK_LIMIT.get(config, config::getLong))</span>
<span class="fc" id="L615">        .setBufferSize(GCS_INPUT_STREAM_BUFFER_SIZE.get(config, config::getInt))</span>
<span class="fc" id="L616">        .setFadvise(GCS_INPUT_STREAM_FADVISE.get(config, config::getEnum))</span>
<span class="fc" id="L617">        .setMinRangeRequestSize(GCS_INPUT_STREAM_MIN_RANGE_REQUEST_SIZE.get(config, config::getInt))</span>
<span class="fc" id="L618">        .setGenerationReadConsistency(GCS_GENERATION_READ_CONSISTENCY.get(config, config::getEnum))</span>
<span class="fc" id="L619">        .build();</span>
  }

  private static AsyncWriteChannelOptions getWriteChannelOptions(Configuration config) {
<span class="fc" id="L623">    return AsyncWriteChannelOptions.builder()</span>
<span class="fc" id="L624">        .setBufferSize(GCS_OUTPUT_STREAM_BUFFER_SIZE.get(config, config::getInt))</span>
<span class="fc" id="L625">        .setPipeBufferSize(GCS_OUTPUT_STREAM_PIPE_BUFFER_SIZE.get(config, config::getInt))</span>
<span class="fc" id="L626">        .setUploadChunkSize(GCS_OUTPUT_STREAM_UPLOAD_CHUNK_SIZE.get(config, config::getInt))</span>
<span class="fc" id="L627">        .setDirectUploadEnabled(</span>
<span class="fc" id="L628">            GCS_OUTPUT_STREAM_DIRECT_UPLOAD_ENABLE.get(config, config::getBoolean))</span>
<span class="fc" id="L629">        .build();</span>
  }

  private static RequesterPaysOptions getRequesterPaysOptions(
      Configuration config, String projectId) {
<span class="fc" id="L634">    String requesterPaysProjectId = GCS_REQUESTER_PAYS_PROJECT_ID.get(config, config::get);</span>
<span class="fc" id="L635">    return RequesterPaysOptions.builder()</span>
<span class="pc bpc" id="L636" title="1 of 2 branches missed.">        .setMode(GCS_REQUESTER_PAYS_MODE.get(config, config::getEnum))</span>
<span class="fc" id="L637">        .setProjectId(requesterPaysProjectId == null ? projectId : requesterPaysProjectId)</span>
<span class="fc" id="L638">        .setBuckets(GCS_REQUESTER_PAYS_BUCKETS.getStringCollection(config))</span>
<span class="fc" id="L639">        .build();</span>
  }

  private static CooperativeLockingOptions getCooperativeLockingOptions(Configuration config) {
<span class="fc" id="L643">    return CooperativeLockingOptions.builder()</span>
<span class="fc" id="L644">        .setLockExpirationTimeoutMilli(</span>
<span class="fc" id="L645">            GCS_COOPERATIVE_LOCKING_EXPIRATION_TIMEOUT_MS.get(config, config::getLong))</span>
<span class="fc" id="L646">        .setMaxConcurrentOperations(</span>
<span class="fc" id="L647">            GCS_COOPERATIVE_LOCKING_MAX_CONCURRENT_OPERATIONS.get(config, config::getInt))</span>
<span class="fc" id="L648">        .build();</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.4.201905082037</span></div></body></html>